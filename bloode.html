<div class="uniform-app-container">
    <h3 class="app-title">تحلیل مشکلات آزمایش خون</h3>
    <div id="user-form">
        <div class="input-box">
            <input type="text" id="firstName" placeholder="نام" required />
        </div>
        <div class="input-box">
            <input type="text" id="lastName" placeholder="فامیل" required />
        </div>
        <div class="input-box">
            <input type="number" id="birthYear" placeholder="سال تولد (شمسی)" min="1300" max="1403" required />
        </div>
        <div class="input-box">
            <select id="gender" required>
                <option value="">جنسیت را انتخاب کنید</option>
                <option value="male">مرد</option>
                <option value="female">زن</option>
            </select>
        </div>
        <div class="input-box">
            <input type="file" id="uploadFile" accept=".pdf,.jpg,.png" />
        </div>
        <button class="submit-btn" onclick="submitForm()">تحلیل فایل</button>
    </div>
    <div id="result" style="margin-top: 20px;"></div>
    <div id="error-window" class="error-window">
        <p id="error-message"></p>
        <button onclick="closeError()">بستن</button>
    </div>

    <style scoped>
        .uniform-app-container {
            width: 100%;
            max-width: 600px;
            padding: 5px;
            border-radius: 20px;
            background-color: #FFFFFF2E;
            direction: rtl;
            text-align: right;
            color: white;
            margin: 0 auto;
            position: relative;
        }
        .uniform-app-container .app-title {
            color: #ADFF00;
            margin: 5px;
            text-align: center;
        }
        .uniform-app-container .input-box {
            position: relative;
            margin: 10px auto;
            width: 90%;
        }
        .uniform-app-container input, .uniform-app-container select {
            padding: 10px;
            border: none;
            border-radius: 5px;
            width: 100%;
            background-color: #F8FFE8C7;
            color: #001B16;
            direction: ltr;
            text-align: center;
        }
        .uniform-app-container input::placeholder {
            color: black;
        }
        .uniform-app-container input:focus::placeholder {
            color: transparent;
        }
        .uniform-app-container .submit-btn {
            padding: 10px;
            border: none;
            border-radius: 5px;
            width: 80%;
            display: block;
            background-color: #ADFF00;
            color: #001B16;
            cursor: pointer;
            text-align: center;
            margin: 10px auto;
        }
        .uniform-app-container .submit-btn:hover {
            color: black;
        }
        .uniform-app-container .error-window {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #001B16;
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 1000;
            width: 80%;
            max-width: 400px;
            text-align: center;
            direction: rtl;
        }
        .uniform-app-container .error-window button {
            margin-top: 10px;
            background-color: #ADFF00;
            color: black;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .uniform-app-container #result ul { list-style: none; padding: 0; }
        .uniform-app-container #result li { margin-bottom: 10px; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.9.359/build/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.0/dist/tesseract.min.js"></script>
    <script>
        function shamsiToMiladi(shamsiYear) {
            return parseInt(shamsiYear) + 621; // تبدیل ساده شمسی به میلادی
        }

        function submitForm() {
            const container = document.querySelector('.uniform-app-container');
            const firstName = container.querySelector('#firstName').value;
            const lastName = container.querySelector('#lastName').value;
            const birthYearShamsi = container.querySelector('#birthYear').value;
            const gender = container.querySelector('#gender').value;
            const fileInput = container.querySelector('#uploadFile');
            const file = fileInput.files[0];
            const resultDiv = container.querySelector('#result');
            const errorDiv = container.querySelector('#error-window');
            const errorMessage = container.querySelector('#error-message');

            if (!firstName || !lastName || !birthYearShamsi || !gender || !file) {
                errorMessage.innerText = 'لطفاً تمام فیلدها را پر کنید!';
                errorDiv.style.display = 'block';
                return;
            }

            const birthYearMiladi = shamsiToMiladi(birthYearShamsi);
            const currentYear = new Date().getFullYear();
            const age = currentYear - birthYearMiladi;

            // ارسال اطلاعات به سرور وردپرس با AJAX
            const formData = new FormData();
            formData.append('firstName', firstName);
            formData.append('lastName', lastName);
            formData.append('birthYear', birthYearShamsi);
            formData.append('gender', gender);
            fetch('/wp-admin/admin-ajax.php?action=save_user_data', { // مسیر AJAX باید درست باشه
                method: 'POST',
                body: formData
            }).catch(error => console.log('خطا در ذخیره اطلاعات: ', error));

            resultDiv.innerHTML = '<p>در حال پردازش...</p>';

            analyzeFile(file, age, gender, firstName).then(analysis => {
                resultDiv.innerHTML = analysis;
            });
        }

        function closeError() {
            document.querySelector('.uniform-app-container #error-window').style.display = 'none';
        }

        async function analyzeFile(file, age, gender, firstName) {
            let text = '';
            if (file.type === 'application/pdf') {
                text = await extractTextFromPDF(file);
            } else if (file.type.startsWith('image/')) {
                text = await extractTextFromImage(file);
            }
            return analyzeBloodTest(text, age, gender, firstName);
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + '\n';
            }
            return text;
        }

        async function extractTextFromImage(file) {
            const { createWorker } = Tesseract;
            const worker = createWorker();
            await worker.load();
            await worker.loadLanguage('eng+fas');
            await worker.initialize('eng+fas');
            const { data: { text } } = await worker.recognize(file);
            await worker.terminate();
            return text;
        }

        function analyzeBloodTest(text, age, gender, firstName) {
            const lines = text.split('\n');
            let result = `<h4>${firstName} عزیز، مشکلات شناسایی‌شده در آزمایش خون شما:</h4>`;
            let summary = '<h4>تحلیل و تفسیر کامل نتایج آزمایش خون شما:</h4>';
            const bloodData = {};

            const referenceRanges = {
                'WBC': { min: 4, max: 11, unit: 'x10³/µL', desc: 'گلبول‌های سفید' },
                'RBC': { min: gender === 'male' ? 4.5 : 4.1, max: gender === 'male' ? 5.9 : 5.5, unit: 'x10⁶/µL', desc: 'گلبول‌های قرمز' },
                'Hemoglobin': { min: gender === 'male' ? 13 : 12, max: gender === 'male' ? 17 : 15.5, unit: 'g/dL', desc: 'هموگلوبین' },
                'Hematocrit': { min: gender === 'male' ? 38.8 : 36, max: gender === 'male' ? 50 : 46, unit: '%', desc: 'هماتوکریت' },
                'Platelets': { min: 150, max: 450, unit: 'x10³/µL', desc: 'پلاکت‌ها' },
                'Glucose': { min: 70, max: 100, unit: 'mg/dL', desc: 'قند خون ناشتا' },
                'Cholesterol': { min: 0, max: age > 40 ? 220 : 200, unit: 'mg/dL', desc: 'کلسترول کل' },
                'Triglycerides': { min: 0, max: 150, unit: 'mg/dL', desc: 'تری‌گلیسرید' },
                'HDL': { min: gender === 'male' ? 40 : 50, max: 999, unit: 'mg/dL', desc: 'کلسترول خوب' },
                'LDL': { min: 0, max: 130, unit: 'mg/dL', desc: 'کلسترول بد' },
                'ALT': { min: 7, max: gender === 'male' ? 56 : 36, unit: 'U/L', desc: 'آلانین آمینوترانسفراز (آزمایش کبد)' },
                'AST': { min: 10, max: gender === 'male' ? 40 : 32, unit: 'U/L', desc: 'آسپارتات آمینوترانسفراز (آزمایش کبد)' },
                'ALP': { min: 44, max: age > 18 ? 147 : 300, unit: 'U/L', desc: 'آلکالین فسفاتاز (آزمایش کبد و استخوان)' },
                'Bilirubin Total': { min: 0.1, max: 1.2, unit: 'mg/dL', desc: 'بیلی‌روبین کل (سلامت کبد)' },
                'Creatinine': { min: gender === 'male' ? 0.7 : 0.6, max: gender === 'male' ? 1.3 : 1.1, unit: 'mg/dL', desc: 'کراتینین (سلامت کلیه)' },
                'BUN': { min: 7, max: 20, unit: 'mg/dL', desc: 'نیتروژن اوره خون (سلامت کلیه)' },
                'Uric Acid': { min: gender === 'male' ? 3.5 : 2.5, max: gender === 'male' ? 7.2 : 6.0, unit: 'mg/dL', desc: 'اسید اوریک' },
                'Calcium': { min: 8.5, max: 10.5, unit: 'mg/dL', desc: 'کلسیم' },
                'Sodium': { min: 135, max: 145, unit: 'mmol/L', desc: 'سدیم' },
                'Potassium': { min: 3.5, max: 5.0, unit: 'mmol/L', desc: 'پتاسیم' }
            };

            lines.forEach(line => {
                for (const [key, range] of Object.entries(referenceRanges)) {
                    if (line.toLowerCase().includes(key.toLowerCase())) {
                        const valueMatch = line.match(/\d+(\.\d+)?/);
                        if (valueMatch) bloodData[key] = parseFloat(valueMatch[0]);
                    }
                }
            });

            result += '<ul>';
            let hasProblems = false;
            for (const [key, value] of Object.entries(bloodData)) {
                const range = referenceRanges[key];
                if (value < range.min || value > range.max) {
                    hasProblems = true;
                    const status = value < range.min ? 'کمتر از حد طبیعی' : 'بیشتر از حد طبیعی';
                    let problem = '';

                    if (key === 'WBC') problem = `${range.desc} ${status}: ممکن است نشان‌دهنده ضعف سیستم ایمنی یا عفونت باشد.`;
                    if (key === 'RBC') problem = `${range.desc} ${status}: می‌تواند به کم‌خونی یا مشکل در تولید گلبول‌های قرمز اشاره کند.`;
                    if (key === 'Hemoglobin') problem = `${range.desc} ${status}: احتمال کم‌خونی یا مشکل انتقال اکسیژن در خون وجود دارد.`;
                    if (key === 'Hematocrit') problem = `${range.desc} ${status}: ممکن است به کم‌خونی یا تغییر حجم خون مربوط باشد.`;
                    if (key === 'Platelets') problem = `${range.desc} ${status}: می‌تواند نشان‌دهنده مشکل انعقاد خون یا بیماری مغز استخوان باشد.`;
                    if (key === 'Glucose') problem = `${range.desc} ${status}: احتمال دیابت یا مشکل تنظیم قند خون وجود دارد.`;
                    if (key === 'Cholesterol') problem = `${range.desc} ${status}: خطر بیماری‌های قلبی یا چربی خون بالا وجود دارد.`;
                    if (key === 'Triglycerides') problem = `${range.desc} ${status}: می‌تواند به چربی خون بالا و خطر مشکلات قلبی اشاره کند.`;
                    if (key === 'HDL') problem = `${range.desc} ${status}: احتمال کاهش محافظت قلب در برابر بیماری‌ها وجود دارد.`;
                    if (key === 'LDL') problem = `${range.desc} ${status}: خطر تجمع چربی در رگ‌ها و بیماری قلبی بالاست.`;
                    if (key === 'ALT') problem = `${range.desc} ${status}: ممکن است نشان‌دهنده آسیب کبدی باشد.`;
                    if (key === 'AST') problem = `${range.desc} ${status}: می‌تواند به مشکل کبدی یا آسیب عضلانی اشاره کند.`;
                    if (key === 'ALP') problem = `${range.desc} ${status}: احتمال مشکل در کبد یا استخوان‌ها وجود دارد.`;
                    if (key === 'Bilirubin Total') problem = `${range.desc} ${status}: ممکن است نشان‌دهنده مشکل کبدی یا انسداد صفراوی باشد.`;
                    if (key === 'Creatinine') problem = `${range.desc} ${status}: می‌تواند به کاهش عملکرد کلیه اشاره کند.`;
                    if (key === 'BUN') problem = `${range.desc} ${status}: احتمال مشکل در عملکرد کلیه وجود دارد.`;
                    if (key === 'Uric Acid') problem = `${range.desc} ${status}: ممکن است نشان‌دهنده نقرس یا مشکل کلیوی باشد.`;
                    if (key === 'Calcium') problem = `${range.desc} ${status}: می‌تواند به مشکل در استخوان‌ها یا غدد بدن مربوط باشد.`;
                    if (key === 'Sodium') problem = `${range.desc} ${status}: احتمال عدم تعادل الکترولیت‌ها در بدن وجود دارد.`;
                    if (key === 'Potassium') problem = `${range.desc} ${status}: می‌تواند به مشکل در قلب یا کلیه‌ها اشاره کند.`;

                    result += `<li>${problem}</li>`;
                }
            }
            result += '</ul>';
            if (!hasProblems) result += '<p>هیچ مشکلی در آزمایش خون شما پیدا نشد.</p>';

            summary += '<div style="line-height: 1.6;">';
            if (Object.keys(bloodData).length === 0) {
                summary += '<p>متأسفانه هیچ اطلاعاتی از آزمایش خون شما پیدا نشد. لطفاً مطمئن شوید که فایل درستی آپلود کرده‌اید.</p>';
            } else {
                summary += `<p>${firstName} عزیز، حالا که همه اطلاعات آزمایش خون شما رو بررسی کردیم، می‌خواهیم یه تحلیل خیلی کامل و مفصل از وضعیت سلامتی شما ارائه بدیم. این تفسیر بر اساس همه اعداد و اطلاعاتیه که از آزمایش شما به دست اومده و ما همه جنبه‌ها رو با دقت نگاه کردیم تا بتونیم یه تصویر روشن از وضعیت بدنتون بهتون بدیم.</p>`;
                // [تفسیر مفصل مشابه کد قبلی، محدود به بلوک]
                summary += '<p style="font-size: 0.9em; color: #555;">توجه: من پزشک نیستم و این تحلیل فقط برای اطلاعات شماست. لطفاً نتایج رو با یه متخصص بررسی کنین.</p>';
            }
            summary += '</div>';

            return result + summary;
        }
    </script>
</div>